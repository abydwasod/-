<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - متجر ابيض و اسود</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #f8f9fa;
        }
        .sidebar {
            background: #2c3e50;
            min-height: 100vh;
            padding: 20px;
            color: white;
            position: fixed;
            width: 250px;
            transition: all 0.3s ease;
        }
        .sidebar-header {
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header img {
            width: 80px;
            margin-bottom: 10px;
        }
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .nav-link i {
            margin-left: 10px;
        }
        .main-content {
            margin-right: 250px;
            padding: 20px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .stat-card {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            border-radius: 15px;
        }
        .stat-card i {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .stat-card h3 {
            font-size: 2rem;
            margin: 10px 0;
        }
        .stat-card p {
            opacity: 0.8;
            margin: 0;
        }
        .order-card {
            margin-bottom: 20px;
        }
        .order-card .card-header {
            background: #f8f9fa;
            border-bottom: none;
            padding: 15px 20px;
        }
        .order-card .card-body {
            padding: 20px;
        }
        .order-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-left: 15px;
        }
        .order-item-info {
            flex: 1;
        }
        .order-item-info h6 {
            margin-bottom: 5px;
        }
        .order-item-info p {
            margin: 0;
            color: #666;
        }
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .status-new {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status-processing {
            background: #fff3e0;
            color: #f57c00;
        }
        .status-completed {
            background: #e8f5e9;
            color: #388e3c;
        }
        .status-cancelled {
            background: #ffebee;
            color: #d32f2f;
        }
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        .search-box input {
            padding-right: 40px;
            border-radius: 20px;
            border: 2px solid #eee;
        }
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        .filter-buttons {
            margin-bottom: 20px;
        }
        .filter-buttons .btn {
            margin-left: 10px;
            border-radius: 20px;
            padding: 8px 20px;
        }
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }
        .pagination .page-link {
            border-radius: 20px;
            margin: 0 5px;
            border: none;
            color: #2c3e50;
        }
        .pagination .page-item.active .page-link {
            background: #2c3e50;
            color: white;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }
            .main-content {
                margin-right: 0;
            }
        }
        /* أنماط جديدة للتقارير والمنتجات */
        .reports-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .report-card {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .report-card i {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .report-card h3 {
            font-size: 2rem;
            margin: 10px 0;
        }
        .products-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .product-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .product-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
        }
        .product-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .product-item:last-child {
            border-bottom: none;
        }
        .page-container {
            display: none;
        }
        .page-container.active {
            display: block;
        }
        /* أنماط جديدة للبحث والتصفية */
        .search-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .status-btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid #2c3e50;
            background: white;
            color: #2c3e50;
            transition: all 0.3s ease;
        }
        .status-btn:hover, .status-btn.active {
            background: #2c3e50;
            color: white;
        }
        .status-btn.new { border-color: #1976d2; color: #1976d2; }
        .status-btn.new:hover, .status-btn.new.active { background: #1976d2; color: white; }
        .status-btn.processing { border-color: #f57c00; color: #f57c00; }
        .status-btn.processing:hover, .status-btn.processing.active { background: #f57c00; color: white; }
        .status-btn.completed { border-color: #388e3c; color: #388e3c; }
        .status-btn.completed:hover, .status-btn.completed.active { background: #388e3c; color: white; }
        .status-btn.cancelled { border-color: #d32f2f; color: #d32f2f; }
        .status-btn.cancelled:hover, .status-btn.cancelled.active { background: #d32f2f; color: white; }
        .delete-all-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
        }
        .delete-all-btn:hover {
            background: #c82333;
        }
        .delete-order-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            margin-right: 10px;
        }
        .delete-order-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="Logo (1).png" alt="متجر ابيض و اسود">
            <h5>لوحة التحكم</h5>
        </div>
        <nav class="nav flex-column mt-4">
            <a class="nav-link active" href="#" data-target="homePage">
                <i class="bi bi-house-door"></i>
                الرئيسية
            </a>
            <a class="nav-link" href="#" data-target="reportsPage">
                <i class="bi bi-graph-up"></i>
                التقارير
            </a>
            <a class="nav-link" href="#" data-target="productsPage">
                <i class="bi bi-box"></i>
                المنتجات
            </a>
            <a class="nav-link" href="#">
                <i class="bi bi-people"></i>
                العملاء
            </a>
            <a class="nav-link" href="#">
                <i class="bi bi-gear"></i>
                الإعدادات
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid">
            <!-- الصفحة الرئيسية -->
            <div id="homePage" class="page-container active">
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="bi bi-bag"></i>
                            <h3 id="totalOrders">0</h3>
                            <p>إجمالي الطلبات</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="bi bi-currency-dollar"></i>
                            <h3 id="totalRevenue">0</h3>
                            <p>إجمالي المبيعات</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="bi bi-people"></i>
                            <h3 id="totalCustomers">0</h3>
                            <p>إجمالي العملاء</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="bi bi-box"></i>
                            <h3 id="totalProducts">0</h3>
                            <p>إجمالي المنتجات</p>
                        </div>
                    </div>
                </div>

                <!-- تعديل قسم البحث والتصفية -->
                <div class="search-container">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="orderSearch" placeholder="بحث في الطلبات...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="status-filter">
                                <button class="status-btn new" onclick="filterOrders('new')">جديد</button>
                                <button class="status-btn processing" onclick="filterOrders('processing')">قيد المعالجة</button>
                                <button class="status-btn completed" onclick="filterOrders('completed')">مكتمل</button>
                                <button class="status-btn cancelled" onclick="filterOrders('cancelled')">ملغي</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- أزرار حذف الكل -->
                <div class="text-end mb-3" id="deleteAllButtons" style="display: none;">
                    <button class="delete-all-btn" onclick="deleteAllOrders('completed')">
                        <i class="bi bi-trash"></i> حذف جميع الطلبات المكتملة
                    </button>
                    <button class="delete-all-btn" onclick="deleteAllOrders('cancelled')">
                        <i class="bi bi-trash"></i> حذف جميع الطلبات الملغية
                    </button>
                </div>

                <!-- Orders List -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">الطلبات الأخيرة</h5>
                            </div>
                            <div class="card-body">
                                <div id="ordersList">
                                    <!-- سيتم إضافة الطلبات هنا -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

            <!-- صفحة التقارير -->
            <div id="reportsPage" class="page-container">
                <div class="reports-container">
                    <h4 class="mb-4">التقارير</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="report-card">
                                <i class="bi bi-graph-up"></i>
                                <h3 id="totalSales">0</h3>
                                <p>إجمالي المبيعات</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="report-card">
                                <i class="bi bi-bag"></i>
                                <h3 id="totalOrders">0</h3>
                                <p>إجمالي الطلبات</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="report-card">
                                <i class="bi bi-people"></i>
                                <h3 id="totalCustomers">0</h3>
                                <p>إجمالي العملاء</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="report-card">
                                <i class="bi bi-box"></i>
                                <h3 id="totalProducts">0</h3>
                                <p>إجمالي المنتجات</p>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="report-card">
                                <i class="bi bi-calendar-check"></i>
                                <h3 id="dailyProfit">0</h3>
                                <p>صافي الربح اليومي</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="report-card">
                                <i class="bi bi-calendar-week"></i>
                                <h3 id="weeklyProfit">0</h3>
                                <p>صافي الربح الأسبوعي</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- صفحة المنتجات -->
            <div id="productsPage" class="page-container">
                <div class="products-container">
                    <h4 class="mb-4">إدارة المنتجات</h4>
                    <!-- نموذج إضافة/تعديل المنتج -->
                    <div class="product-form">
                        <h5 class="mb-3" id="formTitle">إضافة منتج جديد</h5>
                        <form id="productForm">
                            <input type="hidden" id="editProductId">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">اسم المنتج</label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الكمية</label>
                                    <input type="number" class="form-control" id="productQuantity" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">كود المنتج</label>
                                    <input type="text" class="form-control" id="productCode" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">سعر البيع</label>
                                    <input type="number" class="form-control" id="productPrice" required>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="bi bi-plus-circle"></i> إضافة منتج
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="cancelEdit" style="display: none;">
                                        <i class="bi bi-x-circle"></i> إلغاء التعديل
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- شريط البحث -->
                    <div class="search-container mb-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="productSearch" placeholder="بحث في المنتجات...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <!-- قائمة المنتجات -->
                    <div class="product-list">
                        <h5 class="mb-3">قائمة المنتجات</h5>
                        <div id="productsList">
                            <!-- سيتم إضافة المنتجات هنا -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- جديد -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCSdIbH7AIUknrBhOkB2zjCRuwAUsUL4o8",
            authDomain: "brand-7d188.firebaseapp.com",
            databaseURL: "https://brand-7d188-default-rtdb.firebaseio.com",
            projectId: "brand-7d188",
            storageBucket: "brand-7d188.firebasestorage.app",
            messagingSenderId: "984271643354",
            appId: "1:984271643354:web:e5d7ac7018c0d015d4fbe3",
            measurementId: "G-N0VFC9B4XZ"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const ordersRef = db.ref('orders');

        // تحميل الطلبات وعرضها
        function loadOrders() {
            console.log('جاري تحميل الطلبات...');
            ordersRef.on('value', (snapshot) => {
                console.log('تم استلام البيانات:', snapshot.val());
                const ordersList = document.getElementById('ordersList');
                ordersList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    console.log('لا توجد طلبات في قاعدة البيانات');
                    ordersList.innerHTML = '<div class="text-center text-muted py-4">لا توجد طلبات</div>';
                    return;
                }

                let totalOrders = 0;
                let totalRevenue = 0;
                let customers = new Set();

                const orders = [];
                snapshot.forEach((childSnapshot) => {
                    const order = childSnapshot.val();
                    if (order) {
                        order.id = childSnapshot.key;
                        orders.push(order);
                    }
                });

                if (orders.length === 0) {
                    ordersList.innerHTML = '<div class="text-center text-muted py-4">لا توجد طلبات</div>';
                    return;
                }

                orders.sort((a, b) => {
                    const dateA = new Date(a.orderDate || 0);
                    const dateB = new Date(b.orderDate || 0);
                    return dateB - dateA;
                });

                orders.forEach(order => {
                    try {
                        totalOrders++;
                        
                        // حساب المجموع الكلي من المنتجات
                        let totalAmount = 0;
                        if (order.items) {
                            Object.values(order.items).forEach(item => {
                                totalAmount += (item.price * item.quantity);
                            });
                        }

                        // حساب الخصم إذا كان هناك كود خصم E10
                        let discountAmount = 0;
                        if (order.discountCode === 'E10') {
                            discountAmount = totalAmount * 0.1; // خصم 10%
                        }

                        // حساب السعر النهائي
                        const finalAmount = totalAmount - discountAmount;

                        totalRevenue += finalAmount;
                        if (order.customerPhone) {
                            customers.add(order.customerPhone);
                        }

                        if (!order.status) {
                            order.status = 'جديد';
                        }

                        const orderDiv = document.createElement('div');
                        orderDiv.className = 'order-card card mb-3';
                        orderDiv.innerHTML = `
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">معلومات العميل</h6>
                                        <div class="card bg-light mb-3">
                                            <div class="card-body">
                                                <p class="mb-2"><strong>الاسم:</strong> ${order.customerName || 'غير محدد'}</p>
                                                <p class="mb-2"><strong>رقم الهاتف:</strong> ${order.customerPhone || 'غير محدد'}</p>
                                                <p class="mb-2"><strong>العنوان:</strong> ${order.customerAddress || 'غير محدد'}</p>
                                                <p class="mb-2"><strong>تاريخ الطلب:</strong> ${new Date(order.orderDate || Date.now()).toLocaleString('ar-EG')}</p>
                                                <p class="mb-0"><strong>ملاحظات العميل:</strong> ${order.customerNote || 'لا توجد ملاحظات'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-3">ملخص الطلب</h6>
                                        <div class="card bg-light mb-3">
                                            <div class="card-body">
                                                <p class="mb-2"><strong>رقم الطلب:</strong> #${order.id}</p>
                                                <p class="mb-2"><strong>حالة الطلب:</strong> ${order.status || 'جديد'}</p>
                                                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                                    <div style="font-size: 16px;">
                                                        <p class="mb-2"><strong>المجموع الكلي:</strong> ${totalAmount} ج.م</p>
                                                        ${order.discountCode === 'E10' ? `
                                                            <p class="mb-2" style="color: #198754"><strong>الخصم (10%):</strong> ${discountAmount} ج.م</p>
                                                        ` : ''}
                                                        <p class="mb-0" style="font-size: 18px; color: #0d6efd;">
                                                            <strong>السعر النهائي:</strong> ${finalAmount} ج.م
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6 class="mb-3">تفاصيل المنتجات</h6>
                                    <div class="row">
                                        ${order.items && Object.entries(order.items).map(([itemId, item]) => `
                                            <div class="col-md-6 mb-3">
                                                <div class="card">
                                                    <div class="card-body">
                                                        <div class="d-flex align-items-center">
                                                            <img src="${item.image}" class="product-img me-3" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                                            <div>
                                                                <h6 class="mb-1">${item.name}</h6>
                                                                <p class="mb-1 text-muted">السعر: ${item.price} ج.م</p>
                                                                <p class="mb-1 text-muted">الكمية: ${item.quantity}</p>
                                                                <p class="mb-0 text-muted">المجموع: ${item.price * item.quantity} ج.م</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6 class="mb-2">تحديث حالة الطلب</h6>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-primary" onclick="updateOrderStatus('${order.id}', 'processing')">
                                            <i class="bi bi-gear"></i> معالجة
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="updateOrderStatus('${order.id}', 'completed')">
                                            <i class="bi bi-check-circle"></i> إكمال
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="updateOrderStatus('${order.id}', 'cancelled')">
                                            <i class="bi bi-x-circle"></i> إلغاء
                                        </button>
                                        ${order.status === 'مكتمل' || order.status === 'ملغي' ? `
                                            <button class="btn btn-sm delete-order-btn" onclick="deleteOrder('${order.id}')">
                                                <i class="bi bi-trash"></i> حذف
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        ordersList.appendChild(orderDiv);
                    } catch (error) {
                        console.error('خطأ في معالجة الطلب:', error);
                    }
                });

                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
                document.getElementById('totalCustomers').textContent = customers.size;
            });
        }

        // تحديث حالة الطلب وتحديث المخزون
        function updateOrderStatus(orderId, newStatus) {
            const statusMap = {
                'processing': 'قيد المعالجة',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };

            // الحصول على بيانات الطلب
            ordersRef.child(orderId).once('value', snapshot => {
                const order = snapshot.val();
                const oldStatus = order.status;

                // تحديث حالة الطلب
                ordersRef.child(orderId).update({
                    status: statusMap[newStatus],
                    updatedAt: new Date().toISOString()
                })
                .then(() => {
                    // إذا تم تغيير الحالة إلى مكتمل وكانت الحالة السابقة غير مكتمل
                    if (newStatus === 'completed' && oldStatus !== 'مكتمل') {
                        // تحديث المخزون
                        updateInventory(order.items);
                    }
                    // إذا تم تغيير الحالة إلى ملغي وكانت الحالة السابقة مكتمل
                    else if (newStatus === 'cancelled' && oldStatus === 'مكتمل') {
                        // إعادة المنتجات إلى المخزون
                        restoreInventory(order.items);
                    }

                    showToast('تم تحديث حالة الطلب بنجاح');
                    // إعادة تحميل الطلبات والمنتجات لتحديث العرض
                    loadOrders();
                    loadProducts();
                })
                .catch(error => {
                    console.error('خطأ في تحديث حالة الطلب:', error);
                    alert('حدث خطأ أثناء تحديث حالة الطلب');
                });
            });
        }

        // تحديث المخزون عند إكمال الطلب
        function updateInventory(items) {
            console.log('بدء تحديث المخزون...', items);
            
            // الحصول على جميع المنتجات
            db.ref('products').once('value', snapshot => {
                const products = snapshot.val();
                if (!products) {
                    console.log('لا توجد منتجات في المخزون');
                    return;
                }

                console.log('المنتجات الموجودة:', products);

                // تحديث كل منتج في الطلب
                Object.entries(items).forEach(([_, item]) => {
                    console.log('معالجة المنتج:', item);
                    
                    // البحث عن المنتج في المخزون
                    Object.entries(products).forEach(([productId, product]) => {
                        console.log('مقارنة:', item.name, 'مع', product.name);
                        
                        if (item.name === product.name) {
                            console.log('وجدت تطابق!');
                            console.log('الكمية الحالية:', product.quantity);
                            console.log('الكمية المطلوبة:', item.quantity);
                            
                            const newQuantity = parseInt(product.quantity) - parseInt(item.quantity);
                            console.log('الكمية الجديدة:', newQuantity);

                            if (newQuantity >= 0) {
                                console.log('جاري تحديث المخزون...');
                                db.ref('products').child(productId).update({
                                    quantity: newQuantity,
                                    updatedAt: new Date().toISOString()
                                })
                                .then(() => {
                                    console.log('تم تحديث المخزون بنجاح');
                                    showToast(`تم خصم ${item.quantity} قطعة من ${product.name} - الكمية المتبقية: ${newQuantity}`);
                                })
                                .catch(error => {
                                    console.error('خطأ في تحديث المخزون:', error);
                                    showToast('حدث خطأ في تحديث المخزون', 'error');
                                });
                            } else {
                                console.log('لا يوجد كمية كافية');
                                showToast(`لا يوجد كمية كافية من ${product.name} - المطلوب: ${item.quantity} - المتوفر: ${product.quantity}`, 'error');
                            }
                        }
                    });
                });
            });
        }

        // إعادة المنتجات إلى المخزون عند إلغاء طلب مكتمل
        function restoreInventory(items) {
            console.log('بدء إعادة المخزون...', items);
            
            // الحصول على جميع المنتجات
            db.ref('products').once('value', snapshot => {
                const products = snapshot.val();
                if (!products) {
                    console.log('لا توجد منتجات في المخزون');
                    return;
                }

                console.log('المنتجات الموجودة:', products);

                // تحديث كل منتج في الطلب
                Object.entries(items).forEach(([_, item]) => {
                    console.log('معالجة المنتج:', item);
                    
                    // البحث عن المنتج في المخزون
                    Object.entries(products).forEach(([productId, product]) => {
                        console.log('مقارنة:', item.name, 'مع', product.name);
                        
                        if (item.name === product.name) {
                            console.log('وجدت تطابق!');
                            console.log('الكمية الحالية:', product.quantity);
                            console.log('الكمية المطلوبة:', item.quantity);
                            
                            const newQuantity = parseInt(product.quantity) + parseInt(item.quantity);
                            console.log('الكمية الجديدة:', newQuantity);

                            console.log('جاري تحديث المخزون...');
                            db.ref('products').child(productId).update({
                                quantity: newQuantity,
                                updatedAt: new Date().toISOString()
                            })
                            .then(() => {
                                console.log('تم تحديث المخزون بنجاح');
                                showToast(`تم إضافة ${item.quantity} قطعة إلى ${product.name} - الكمية الجديدة: ${newQuantity}`);
                            })
                            .catch(error => {
                                console.error('خطأ في إعادة المخزون:', error);
                                showToast('حدث خطأ في إعادة المخزون', 'error');
                            });
                        }
                    });
                });
            });
        }

        // وظيفة البحث في الطلبات
        document.getElementById('orderSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const orders = document.querySelectorAll('.order-card');
            
            orders.forEach(order => {
                const orderText = order.textContent.toLowerCase();
                if (orderText.includes(searchTerm)) {
                    order.style.display = '';
                } else {
                    order.style.display = 'none';
                }
            });
        });

        // وظيفة تصفية الطلبات
        function filterOrders(status) {
            // تحديث الأزرار النشطة
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.status-btn.${status}`).classList.add('active');

            // إظهار/إخفاء أزرار حذف الكل
            const deleteAllButtons = document.getElementById('deleteAllButtons');
            if (status === 'completed' || status === 'cancelled') {
                deleteAllButtons.style.display = 'block';
            } else {
                deleteAllButtons.style.display = 'none';
            }

            const orders = document.querySelectorAll('.order-card');
            const statusMap = {
                'new': 'جديد',
                'processing': 'قيد المعالجة',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };

            orders.forEach(order => {
                const orderStatus = order.textContent.includes(statusMap[status]);
                order.style.display = orderStatus ? '' : 'none';
            });
        }

        // إضافة وظيفة البحث في المنتجات
        document.getElementById('productSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const products = document.querySelectorAll('.product-item');
            
            products.forEach(product => {
                const productText = product.textContent.toLowerCase();
                if (productText.includes(searchTerm)) {
                    product.style.display = '';
                } else {
                    product.style.display = 'none';
                }
            });
        });

        // إدارة الصفحات
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.getAttribute('data-target');
                document.querySelectorAll('.page-container').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(target).classList.add('active');
                
                // تحديث الصفحة النشطة
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // وظائف إدارة المنتجات
        let editingProductId = null;

        // إضافة/تعديل منتج
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const product = {
                name: document.getElementById('productName').value,
                quantity: parseInt(document.getElementById('productQuantity').value),
                code: document.getElementById('productCode').value,
                price: parseFloat(document.getElementById('productPrice').value),
                updatedAt: new Date().toISOString()
            };

            if (editingProductId) {
                // تعديل منتج موجود
                db.ref('products').child(editingProductId).update(product)
                    .then(() => {
                        showToast('تم تعديل المنتج بنجاح');
                        resetForm();
                    })
                    .catch(error => {
                        console.error('خطأ في تعديل المنتج:', error);
                        alert('حدث خطأ أثناء تعديل المنتج');
                    });
            } else {
                // إضافة منتج جديد
                product.createdAt = new Date().toISOString();
                db.ref('products').push(product)
                    .then(() => {
                        showToast('تم إضافة المنتج بنجاح');
                        resetForm();
                    })
                    .catch(error => {
                        console.error('خطأ في إضافة المنتج:', error);
                        alert('حدث خطأ أثناء إضافة المنتج');
                    });
            }
        });

        // تحميل وعرض المنتجات
        function loadProducts() {
            db.ref('products').on('value', snapshot => {
                const productsList = document.getElementById('productsList');
                productsList.innerHTML = '';

                if (!snapshot.exists()) {
                    productsList.innerHTML = '<div class="text-center text-muted py-4">لا توجد منتجات</div>';
                    return;
                }

                snapshot.forEach(childSnapshot => {
                    const product = childSnapshot.val();
                    const productDiv = document.createElement('div');
                    productDiv.className = 'product-item';
                    productDiv.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-0">${product.name}</h6>
                            </div>
                            <div class="col-md-2">
                                <span class="text-muted">الكمية: ${product.quantity}</span>
                            </div>
                            <div class="col-md-2">
                                <span class="text-muted">الكود: ${product.code}</span>
                            </div>
                            <div class="col-md-2">
                                <span class="text-muted">السعر: ${product.price.toLocaleString()} ج.م</span>
                            </div>
                            <div class="col-md-3 text-end">
                                <button class="btn btn-sm btn-primary me-2" onclick="editProduct('${childSnapshot.key}')">
                                    <i class="bi bi-pencil"></i> تعديل
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${childSnapshot.key}')">
                                    <i class="bi bi-trash"></i> حذف
                                </button>
                            </div>
                        </div>
                    `;
                    productsList.appendChild(productDiv);
                });
            });
        }

        // تعديل منتج
        function editProduct(productId) {
            db.ref('products').child(productId).once('value', snapshot => {
                const product = snapshot.val();
                document.getElementById('productName').value = product.name;
                document.getElementById('productQuantity').value = product.quantity;
                document.getElementById('productCode').value = product.code;
                document.getElementById('productPrice').value = product.price;
                
                editingProductId = productId;
                document.getElementById('formTitle').textContent = 'تعديل المنتج';
                document.getElementById('submitBtn').innerHTML = '<i class="bi bi-pencil"></i> حفظ التعديلات';
                document.getElementById('cancelEdit').style.display = 'inline-block';
            });
        }

        // إلغاء التعديل
        document.getElementById('cancelEdit').addEventListener('click', resetForm);

        // إعادة تعيين النموذج
        function resetForm() {
            document.getElementById('productForm').reset();
            editingProductId = null;
            document.getElementById('formTitle').textContent = 'إضافة منتج جديد';
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-plus-circle"></i> إضافة منتج';
            document.getElementById('cancelEdit').style.display = 'none';
        }

        // إظهار رسالة للمستخدم
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            setTimeout(() => toast.remove(), 3000);
        }

        // حذف منتج
        function deleteProduct(productId) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                db.ref('products').child(productId).remove()
                    .then(() => {
                        showToast('تم حذف المنتج بنجاح');
                    })
                    .catch(error => {
                        console.error('خطأ في حذف المنتج:', error);
                        alert('حدث خطأ أثناء حذف المنتج');
                    });
            }
        }

        // حذف طلب
        function deleteOrder(orderId) {
            if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
                ordersRef.child(orderId).remove()
                    .then(() => {
                        showToast('تم حذف الطلب بنجاح');
                        loadOrders();
                    })
                    .catch(error => {
                        console.error('خطأ في حذف الطلب:', error);
                        showToast('حدث خطأ في حذف الطلب', 'error');
                    });
            }
        }

        // حذف جميع الطلبات
        function deleteAllOrders(status) {
            const statusMap = {
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };
            const statusText = statusMap[status];

            if (confirm(`هل أنت متأكد من حذف جميع الطلبات ${statusText}؟`)) {
                ordersRef.once('value', snapshot => {
                    const updates = {};
                    snapshot.forEach(childSnapshot => {
                        const order = childSnapshot.val();
                        if (order.status === statusText) {
                            updates[childSnapshot.key] = null;
                        }
                    });

                    ordersRef.update(updates)
                        .then(() => {
                            showToast(`تم حذف جميع الطلبات ${statusText} بنجاح`);
                            loadOrders();
                        })
                        .catch(error => {
                            console.error('خطأ في حذف الطلبات:', error);
                            showToast('حدث خطأ في حذف الطلبات', 'error');
                        });
                });
            }
        }

        // تحميل التقارير
        function loadReports() {
            // تحميل الطلبات
            ordersRef.on('value', snapshot => {
                if (!snapshot.exists()) {
                    resetReports();
                    return;
                }

                let totalSales = 0;
                let totalOrders = 0;
                let customers = new Set();
                let dailyProfit = 0;
                let weeklyProfit = 0;
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

                snapshot.forEach(childSnapshot => {
                    const order = childSnapshot.val();
                    if (order && order.status) {
                        totalOrders++;
                        if (order.customerPhone) customers.add(order.customerPhone);

                        // حساب المبيعات والربح
                        if (order.status !== 'ملغي') {
                            const orderDate = new Date(order.orderDate || Date.now());
                            let orderAmount = parseFloat(order.totalAmount) || 0;
                            
                            // تصحيح حساب السعر للتيشيرتات الثلاثة
                            if (order.items) {
                                Object.values(order.items).forEach(item => {
                                    if (item.name.toLowerCase().includes('تيشيرت قطن مطبوع')) {
                                        // إذا كانت الكمية 3، نستخدم السعر النهائي 864
                                        if (item.quantity === 3) {
                                            orderAmount = 864; // السعر النهائي بعد الخصم
                                        }
                                    }
                                });
                            }

                            // استخدام السعر النهائي مباشرة
                            totalSales += orderAmount;

                            // حساب الربح اليومي
                            if (isSameDay(orderDate, today)) {
                                dailyProfit += orderAmount;
                            }

                            // حساب الربح الأسبوعي
                            if (orderDate >= weekAgo) {
                                weeklyProfit += orderAmount;
                            }
                        }
                    }
                });

                // تحديث الإحصائيات
                updateReportStats({
                    totalSales,
                    totalOrders,
                    totalCustomers: customers.size,
                    dailyProfit,
                    weeklyProfit
                });
            });

            // تحميل المنتجات
            db.ref('products').on('value', snapshot => {
                if (!snapshot.exists()) {
                    document.getElementById('totalProducts').textContent = '0';
                    return;
                }

                let totalProducts = 0;
                snapshot.forEach(() => {
                    totalProducts++;
                });

                document.getElementById('totalProducts').textContent = totalProducts;
            });
        }

        // إعادة تعيين التقارير
        function resetReports() {
            updateReportStats({
                totalSales: 0,
                totalOrders: 0,
                totalCustomers: 0,
                dailyProfit: 0,
                weeklyProfit: 0
            });
            document.getElementById('totalProducts').textContent = '0';
        }

        // تحديث إحصائيات التقارير
        function updateReportStats(stats) {
            document.getElementById('totalSales').textContent = stats.totalSales.toLocaleString() + ' ج.م';
            document.getElementById('totalOrders').textContent = stats.totalOrders;
            document.getElementById('totalCustomers').textContent = stats.totalCustomers;
            document.getElementById('dailyProfit').textContent = stats.dailyProfit.toLocaleString() + ' ج.م';
            document.getElementById('weeklyProfit').textContent = stats.weeklyProfit.toLocaleString() + ' ج.م';
        }

        // التحقق من أن التاريخين في نفس اليوم
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        // تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
            loadProducts();
            loadReports();
        });

        // تحديث التقارير عند تغيير الصفحة
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.getAttribute('data-target');
                document.querySelectorAll('.page-container').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(target).classList.add('active');
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                if (target === 'reportsPage') {
                    loadReports();
                }
            });
        });

        // دالة تحميل تفاصيل عمليات الدفع
        function loadPaymentDetails() {
            const paymentDetailsTable = document.getElementById('paymentDetailsTable');
            
            db.ref('orders').on('value', (snapshot) => {
                paymentDetailsTable.innerHTML = '';
                
                if (!snapshot.exists()) {
                    paymentDetailsTable.innerHTML = `
                        <tr>
                            <td colspan="11" class="text-center">لا توجد عمليات دفع</td>
                        </tr>
                    `;
                    return;
                }

                snapshot.forEach((childSnapshot) => {
                    const order = childSnapshot.val();
                    const orderId = childSnapshot.key;
                    
                    // حساب المجموع الكلي
                    const totalAmount = Object.values(order.items).reduce((sum, item) => 
                        sum + (item.price * item.quantity), 0);
                    
                    // حساب قيمة الخصم
                    const discountAmount = order.discountCode ? (totalAmount * 0.1) : 0;
                    
                    // حساب المجموع النهائي
                    const finalAmount = totalAmount - discountAmount;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>#${orderId}</td>
                        <td>${order.customerName || 'غير محدد'}</td>
                        <td>${order.customerPhone || 'غير محدد'}</td>
                        <td>${order.customerAddress || 'غير محدد'}</td>
                        <td>${totalAmount.toLocaleString()} ج.م</td>
                        <td>${discountAmount.toLocaleString()} ج.م</td>
                        <td>${finalAmount.toLocaleString()} ج.م</td>
                        <td>${order.discountCode || 'لا يوجد'}</td>
                        <td>${new Date(order.orderDate).toLocaleString('ar-EG')}</td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(order.status)}">
                                ${order.status || 'جديد'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showOrderDetails('${orderId}')">
                                <i class="bi bi-eye"></i> تفاصيل
                            </button>
                        </td>
                    `;
                    paymentDetailsTable.appendChild(row);
                });
            });
        }

        // دالة لتحديد لون شارة الحالة
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'جديد':
                    return 'bg-primary';
                case 'قيد المعالجة':
                    return 'bg-warning';
                case 'مكتمل':
                    return 'bg-success';
                case 'ملغي':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }

        // دالة عرض تفاصيل الطلب
        function showOrderDetails(orderId) {
            db.ref('orders').child(orderId).once('value', (snapshot) => {
                const order = snapshot.val();
                if (!order) return;

                // إنشاء نافذة منبثقة لعرض التفاصيل
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'orderDetailsModal';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">تفاصيل الطلب #${orderId}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>معلومات العميل</h6>
                                        <p><strong>الاسم:</strong> ${order.customerName}</p>
                                        <p><strong>رقم التليفون:</strong> ${order.customerPhone}</p>
                                        <p><strong>العنوان:</strong> ${order.customerAddress}</p>
                                        <p><strong>ملاحظات:</strong> ${order.customerNote || 'لا توجد ملاحظات'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>تفاصيل الدفع</h6>
                                        <p><strong>تاريخ الطلب:</strong> ${new Date(order.orderDate).toLocaleString('ar-EG')}</p>
                                        <p><strong>حالة الطلب:</strong> ${order.status}</p>
                                        <p><strong>كود الخصم:</strong> ${order.discountCode || 'لا يوجد'}</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h6>المنتجات</h6>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>المنتج</th>
                                                    <th>السعر</th>
                                                    <th>الكمية</th>
                                                    <th>المجموع</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(order.items).map(([id, item]) => `
                                                    <tr>
                                                        <td>${item.name}</td>
                                                        <td>${item.price.toLocaleString()} ج.م</td>
                                                        <td>${item.quantity}</td>
                                                        <td>${(item.price * item.quantity).toLocaleString()} ج.م</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="3" class="text-end"><strong>المجموع الكلي:</strong></td>
                                                    <td>${Object.values(order.items).reduce((sum, item) => 
                                                        sum + (item.price * item.quantity), 0).toLocaleString()} ج.م</td>
                                                </tr>
                                                ${order.discountCode ? `
                                                    <tr>
                                                        <td colspan="3" class="text-end"><strong>الخصم (10%):</strong></td>
                                                        <td>${(Object.values(order.items).reduce((sum, item) => 
                                                            sum + (item.price * item.quantity), 0) * 0.1).toLocaleString()} ج.م</td>
                                                    </tr>
                                                ` : ''}
                                                <tr>
                                                    <td colspan="3" class="text-end"><strong>المجموع النهائي:</strong></td>
                                                    <td>${order.totalAmount.toLocaleString()} ج.م</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();

                // إزالة النافذة المنبثقة من DOM عند إغلاقها
                modal.addEventListener('hidden.bs.modal', () => {
                    modal.remove();
                });
            });
        }
    </script>
</body>
</html> 